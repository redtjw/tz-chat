<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/header.css" />
		<style>
			.mui-popover .mui-table-view .mui-table-view-cell a{
				color:#404040;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav title">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;"></a>
		    <a id="openMenu" class="mui-icon mui-icon-right-nav mui-pull-right" style="color: white;">
		    	<img src="image/menu2.png" style="max-height: 20px;max-width: 20px;"/>
		    </a>
		    <h1 class="mui-title title-color">个人头像</h1>
		</header>
		<div class="mui-content">
		    <img id="img_myface" src="" />
		</div>
		<div id="sheet_myface" class="mui-popover mui-popover-bottom mui-popover-action ">
		    <!-- 可选择菜单 -->
		    <ul class="mui-table-view">
		      <li class="mui-table-view-cell">
		        <a id="link_choosePhoto" href="#">选择照片</a>
		      </li>
		      <li class="mui-table-view-cell">
		        <a id="link_savePhoto" href="#">保存照片</a>
		      </li>
		    </ul>
		    <!-- 取消菜单 -->
		    <ul class="mui-table-view">
		      <li class="mui-table-view-cell">
		        <a href="#sheet_myface"><b>取消</b></a>
		      </li>
		    </ul>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js"></script>
		<script type="text/javascript">
			mui.init()
			mui.plusReady(function(){
					refreshFace();
				
				// 添加自定义事件，刷新头像
				window.addEventListener("refresh", function(){
					refreshFace();
				});
				
					
					var openMenu = document.getElementById("openMenu");
					openMenu.addEventListener("tap",function(){
						//传入toggle参数，用户无需关心当前是显示还是隐藏状态，mui会自动识别处理；
					mui('#sheet_myface').popover('toggle');
					});
					
					// 选择照片
					var link_choosePhoto = document.getElementById("link_choosePhoto");
					link_choosePhoto.addEventListener("tap",function(){
						mui.openWindow(
							{
								url:"plugin/v3.1.6/myface-uploader.html",
								id:"plugin/v3.1.6/myface-uploader.html",
								createNew:true
							});
						mui('#sheet_myface').popover('toggle');
					})
					// 保存照片
					var link_savePhoto = document.getElementById("link_savePhoto");
					link_savePhoto.addEventListener("tap",function(){
						plus.nativeUI.showWaiting("下载中");
						var userinfo = app.getGloableUserInfo();
						var faceImage = userinfo.faceImageBig;
						var task = plus.downloader.createDownload(app.serverImgUrl+faceImage,{},
							function(downloadFile,status){
								plus.nativeUI.closeWaiting();
								if(status==200){
									var tempFile = downloadFile.filename;
									// 通过相册保存
									plus.gallery.save(tempFile,function(){
										app.showToast("保存成功","success_2");
									})
								}else{
									app.showToast("下载错误");
									console.log("下载错误")
								}
							});
							
							task.start();// 启动下载任务
					});
					
					
			})
			function refreshFace() {
			// 加载头像
				var userinfo = app.getGloableUserInfo();
				var my_face = document.getElementById("img_myface");
				if(userinfo!=null){
					var faceImage = userinfo.faceImageBig;
					if(app.isNotNull(faceImage)){
						
						my_face.src=app.serverImgUrl+faceImage;
					}
					
				}
				// 设置高度宽度
					var imgWidth = document.body.clientWidth;
					my_face.width=imgWidth;
					my_face.height=imgWidth;
			}
		</script>
	</body>

</html>